<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whales of Margin | 2025 DEX</title>
    <base target="_top">
    <style>
        :root {
            --bg-primary: #050b14;
            --bg-secondary: #0a192f; 
            --accent-color: #00bcd4;
            --hover-color: #00ffff; 
            --text-color: #e6f1ff;
            --card-bg: rgba(16, 33, 62, 0.8);
            --border-glow: 0 0 10px rgba(0, 188, 212, 0.3);
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-color);
            margin: 0;
            overflow-x: hidden;
        }

        nav {
            background-color: var(--bg-secondary);
            padding: 15px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid var(--accent-color);
            box-shadow: var(--border-glow);
        }

        .logo { color: var(--accent-color); font-size: 1.5em; font-weight: bold; letter-spacing: 2px; text-transform: uppercase; }

        .nav-links button {
            background: none; border: none; color: var(--text-color); font-size: 1em;
            margin-left: 25px; cursor: pointer; padding: 8px 15px; transition: 0.3s; border-radius: 20px;
        }

        .nav-links button:hover { color: var(--hover-color); background: rgba(0, 255, 255, 0.1); }
        .nav-links button.active { color: var(--bg-primary); background: var(--accent-color); box-shadow: 0 0 15px var(--accent-color); }

        .page-frame { display: none; padding: 40px 20px; max-width: 1100px; margin: auto; animation: fadeIn 0.5s ease; }
        .page-frame.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card {
            background: var(--card-bg); border: 1px solid rgba(0, 188, 212, 0.2);
            border-radius: 15px; padding: 30px; margin-bottom: 20px; backdrop-filter: blur(10px);
        }

        .aquatic-btn {
            background: linear-gradient(135deg, #008ba3, #00bcd4);
            color: white; border: none; padding: 12px 30px; border-radius: 50px;
            font-weight: bold; cursor: pointer; transition: 0.4s; text-decoration: none; display: inline-block;
        }

        .aquatic-btn:hover { transform: scale(1.05); box-shadow: 0 0 20px var(--hover-color); }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; color: var(--accent-color); padding: 10px; border-bottom: 1px solid #333; }
        td { padding: 15px 10px; border-bottom: 1px solid #222; }

        #logoutbutton { display: none; }

        /* Modal / Popup */
        #signupModal {
            display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
            background:rgba(0,0,0,0.9); z-index:2000; align-items:center; justify-content:center;
        }
    </style>
</head>
<body>

    <nav>
        <div class="logo">Whales of Margin</div>
        <div class="nav-links">

            <button class="active" onclick="openPage('home')">Home</button>
            <button onclick="openPage('swap')">Swap</button>
            <button onclick="openPage('portfolio')">Portfolio</button>
            <button id="logoutbutton" onclick="xumm.logout()">Logout</button>
        </div>
    </nav>

    <div id="home" class="page-frame active">
        <div class="card">
            <h1 id="accountaddress">...</h1>
            <h1>Ocean-Floor Deep Liquidity</h1>
            <p>Welcome to the 2025 Premium XRPL Interface. Clean tokens, verified RWAs, and zero-custody risk.</p>
            <button id="signinbutton" class="aquatic-btn" onclick="doSignIn()">Connect Xaman Wallet</button> 
        </div>
        
        <div class="card">
            <h3>Top Verified Utility Tokens</h3>
            <table>
                <thead>
                    <tr><th>Asset</th><th>Balance</th><th>Value (XRP)</th><th>Status</th></tr>
                </thead>
                <tbody>
                    <tr><td>Gold-RWA</td><td>10.5 oz</td><td>4,200</td><td style="color: #00ff00;">Verified</td></tr>
                    <tr><td>Utility-Node</td><td>1,000,000</td><td>850</td><td style="color: #00ff00;">Active</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="swap" class="page-frame">
        <div class="card">
            <h2>Aquatic Swap</h2>
            <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 10px;">
                <label>From: XRP</label>
                <input type="number" placeholder="0.00" style="width: 100%; padding: 10px; margin: 10px 0; background: #050b14; color: white; border: 1px solid #333;">
                <label>To: [Select Verified Token]</label>
                <button class="aquatic-btn" style="width: 100%; margin-top: 10px;">Review Swap</button>
            </div>
        </div>
    </div>

    <div id="portfolio" class="page-frame">
        <div class="card">
            <h2>Your Deep Sea Vault</h2>
            <p>Hashed Identity: <span id="userHashDisplay" style="color: var(--accent-color);">[Not Connected]</span></p>
            <table id="portfolioTable">
                <thead>
                    <tr><th>Asset</th><th>Balance</th><th>Value (XRP)</th><th>Status</th></tr>
                </thead>
                <tbody id="portfolioTableBody">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="signupModal">
        <div class="card" style="max-width:400px; text-align:center; border: 2px solid var(--accent-color);">
            <h2 style="color:var(--accent-color);">Member Access Required</h2>
            <p>The Swap and Portfolio vaults are restricted to approved members.</p>
            <button onclick="closeModal()" style="background:none; border:none; color:#555; cursor:pointer; text-decoration:underline;">Return to Home</button>
        </div>
    </div>
<script src="https://xumm.app/assets/cdn/xumm.min.js"></script>
<script>
    const APPROVED_TOKENS = [
{ 
        name: "XOGE", 
        currency: "586F676500000000000000000000000000000000", 
        issuer: "rJMtvf5B3GbuFMrqybh5wYVXEH4QE8VyU1", // Example Issuer
        icon: "https://uas.xrpscan.com/x/ClassyXoge?ttl=24h&fallback=https://xrpscan.com/static/media/xrpl-symbol-black.cc259dd1.svg&k=4" 
    },
    { 
        name: "Freedom Phoenix Token", 
        currency: "FPT", 
        issuer: "rBXRBN9gSFE4qL6DGWYHgKCLtoMzUVL5cF", // Example Issuer
        icon: "https://xrpscan.com/static/media/xrpl-symbol-black.cc259dd1.svg" 
    },
    { 
        name: "NBunnU", 
        currency: "4E42554E4E550000000000000000000000000000", 
        issuer: "rsdDZFHp1GXp1GMacDFne2ekSjjfWmhvKu", // Example Issuer
        icon: "https://xrpscan.com/static/media/xrpl-symbol-black.cc259dd1.svg" 
    },
    { 
        name: "Xmeme", 
        currency: "584D454D45000000000000000000000000000000", 
        issuer: "r4UPddYeGeZgDhSGPkooURsQtmGda4oYQW", // Example Issuer
        icon: "https://xrpscan.com/static/media/xrpl-symbol-black.cc259dd1.svg" 
    },
    { 
        name: "Blue Umbrella Token", 
        currency: "BUT", 
        issuer: "riQtZKAtGWGRThMNBGz8RtLGAKHd7Za8x", // Example Issuer
        icon: "https://www.gravatar.com/avatar/7839824a835a6b047cc6a1a7f2ce3b73.png?d=blank&s=400" 
    },
    { 
        name: "Lynx", 
        currency: "244C594E58000000000000000000000000000000", 
        issuer: "rsr8BspVLwDWgrYamEJE3mqZhKozfWLfkv", // Example Issuer
        icon: "https://xrpscan.com/static/media/xrpl-symbol-black.cc259dd1.svg" 
    },
    { 
        name: "UgA BuGa", 
        currency: "UGA", 
        issuer: "rBFJGmWj6YaabVCxfsjiCM8pfYXs8xFdeC", // Example Issuer
        icon: "https://xrpscan.com/static/media/xrpl-symbol-black.cc259dd1.svg" 
    },
    { 
        name: "X Joy", 
        currency: "584A4F5900000000000000000000000000000000", 
        issuer: "rJAvx8FtrLR3RyZyM1LyVQFxxsLdT1PmdS", // Example Issuer
        icon: "https://xrpscan.com/static/media/xrpl-symbol-black.cc259dd1.svg" 
    },
    { 
        name: "xSPECTAR", 
        currency: "7853504543544152000000000000000000000000", 
        issuer: "rh5jzTCdMRCVjQ7LT6zucjezC47KATkuvv", // Example Issuer
        icon: "https://uas.xrpscan.com/x/xspectar?ttl=24h&fallback=https://xrpscan.com/static/media/xrpl-symbol-black.cc259dd1.svg&k=4" 
    },
    { 
        name: "Equilibrium games", 
        currency: "457175696C69627269756D000000000000000000", 
        issuer: "rpakCr61Q92abPXJnVboKENmpKssWyHpwu", // Example Issuer
        icon: "https://uas.xrpscan.com/x/Equilibrium_G?ttl=24h&fallback=https://xrpscan.com/static/media/xrpl-symbol-black.cc259dd1.svg&k=4" 
    },
    { 
        name: "Health Ai", 
        currency: "4841494300000000000000000000000000000000", 
        issuer: "rsEXqMHTKDfGzncfJ25XtB9ZY8jayTv7N3", // Example Issuer
        icon: "https://uas.xrpscan.com/x/healthaicoin?ttl=24h&fallback=https://xrpscan.com/static/media/xrpl-symbol-black.cc259dd1.svg&k=4" 
    }
];
    
    const xumm = new Xumm('c5faed1c-cd38-4f99-ab56-73432c940bb2');
    let userLoggedIn = false;

    xumm.on("ready", async () => {
        const checkSession = async () => {
            const account = await xumm.user.account;
            if (account) handleSuccess(account);
        };

        checkSession();

        document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === "visible") checkSession();
        });

        const urlParams = new URLSearchParams(window.location.search);
        const pId = urlParams.get('xummPayloadUUID');
        if (pId) {
            const res = await xumm.payload.get(pId);
            if (res?.response?.account) {
                handleSuccess(res.response.account);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }
    });

    async function doSignIn() {
        xumm.authorize().catch(err => alert("Sign-in Error: " + err.message));
    }

async function handleSuccess(account) {
    userLoggedIn = true;
    
    // 1. Update UI Elements
    document.getElementById('accountaddress').innerText = account;
    document.getElementById('signinbutton').style.display = 'none';
    document.getElementById('logoutbutton').style.display = 'inline-block';
    
    const hashDisp = document.getElementById('userHashDisplay');
    if (hashDisp) hashDisp.innerText = "Connected: " + account.substring(0, 10);

    try {
        // 2. Fetch the actual tokens from the ledger
        const tokens = await getLedgerBalances(account);
        const tableBody = document.getElementById("portfolioTableBody");
        if (!tableBody) return;

        tableBody.innerHTML = ""; // Clear "Loading..."

        // 3. First: Show all random tokens found in the wallet
        if (tokens && tokens.length > 0) {
            tokens.forEach(token => {
                let currencyName = token.currency.length > 3 ? "Custom Token" : token.currency;
                tableBody.innerHTML += `
                    <tr>
                        <td>${currencyName}</td>
                        <td>${parseFloat(token.balance).toFixed(2)}</td>
                        <td>--</td> 
                        <td style="color: #00ff00;">On-Chain</td>
                    </tr>
                `;
            });
        } else {
            tableBody.innerHTML = "<tr><td colspan='4'>No organic tokens found.</td></tr>";
        }

        // 4. Second: Append the "Approved" artifacts (even if balance is 0)
        populateTokenList(tokens);

    } catch (e) {
        console.error("Ledger error:", e);
        document.getElementById("portfolioTableBody").innerHTML = "<tr><td colspan='4'>Error loading vault data.</td></tr>";
    }
}

    xumm.on("logout", () => {
        userLoggedIn = false;
        location.reload();
    });
    async function setTrustline(symbol, issuer) {
    // 1. Define the Transaction "Recipe"
    const payload = {
        "txjson": {
            "TransactionType": "TrustSet",
            "Account": xumm.user.account, // The logged-in user
            "LimitAmount": {
                "currency": symbol,
                "issuer": issuer,
                "value": "1000000000" // A high limit so they never have to adjust it
            }
        }
    };

    try {
        // 2. Send the payload to Xaman
        const request = await xumm.payload.create(payload);
        
        // 3. Open the request for the user
        if (request.next.always) {
            // Mobile: This triggers a "Deep Link" to open Xaman app
            // Desktop: This opens a new tab with a QR code
            window.open(request.next.always, '_blank');
        }
    } catch (err) {
        console.error("Payload error:", err);
        alert("Transaction failed. Are you connected to Xaman?");
    }
}

    function openPage(pageId) {
        if ((pageId === 'swap' || pageId === 'portfolio') && !userLoggedIn) {
            document.getElementById('signupModal').style.display = 'flex';
            return;
        }
        
        // Hide all pages, show the selected one
        document.querySelectorAll('.page-frame').forEach(f => f.classList.remove('active'));
        const targetPage = document.getElementById(pageId);
        if (targetPage) targetPage.classList.add('active');

        // Update nav button highlights
        document.querySelectorAll('.nav-links button').forEach(b => b.classList.remove('active'));
        // We find the button by its onclick text since IDs weren't added to HTML
        const buttons = document.querySelectorAll('.nav-links button');
        buttons.forEach(btn => {
            if (btn.getAttribute('onclick')?.includes(pageId)) btn.classList.add('active');
        });
    }

    function closeModal() { document.getElementById('signupModal').style.display = 'none'; }

    async function getLedgerBalances(walletAddress) {
        try {
            const response = await fetch("https://xrplcluster.com", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    method: "account_lines",
                    params: [{ account: walletAddress, ledger_index: "validated" }]
                })
            });
            const data = await response.json();
            return data.result.lines || [];
        } catch (e) {
            return [];
        }
    }
    function populateTokenList(userBalances = []) {
    const container = document.getElementById('portfolioTableBody');
    // container.innerHTML = "";  <-- REMOVE OR COMMENT THIS OUT
    
// 1. Check if the user's ledger data matches your approved token
    const userMatch = ledgerBalances.find(b => 
        b.account === approved.issuer && 
        b.currency === approved.currency
    );

    // 2. Determine the display values
    const balance = userMatch ? parseFloat(userMatch.balance).toFixed(2) : "0.00";
    
    // 3. Create the Marker (The Checkmark)
// Inside populateTokenList loop
let statusMarker = '';
if (match) {
    statusMarker = '<span style="color: #00ff00; font-weight: bold;">âœ“ Owned</span>';
} else {
    // We pass the specific token's currency and issuer into the function
    statusMarker = `<button class="aquatic-btn" 
                    onclick="setTrustline('${approved.currency}', '${approved.issuer}')" 
                    style="padding: 5px 10px; font-size: 0.8em;">+ Add Trust</button>`;
}

    // 4. Inject into Table
    tableBody.innerHTML += `
        <tr>
            <td>${approved.name}</td>
            <td>${balance}</td>
            <td>--</td> 
            <td>${statusMarker}</td>
        </tr>
    `;
});
    }
</script>
</body>
</html>     
