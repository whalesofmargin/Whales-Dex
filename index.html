<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whales of Margin | 2025 DEX</title>
    <base target="_top">
    <style>
        :root {
            --bg-primary: #050b14;
            --bg-secondary: #0a192f; 
            --accent-color: #00bcd4;
            --hover-color: #00ffff; 
            --text-color: #e6f1ff;
            --card-bg: rgba(16, 33, 62, 0.8);
            --border-glow: 0 0 10px rgba(0, 188, 212, 0.3);
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-color);
            margin: 0;
            overflow-x: hidden;
        }

        nav {
            background-color: var(--bg-secondary);
            padding: 15px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid var(--accent-color);
            box-shadow: var(--border-glow);
        }

        .logo { color: var(--accent-color); font-size: 1.5em; font-weight: bold; letter-spacing: 2px; text-transform: uppercase; }

        .nav-links button {
            background: none; border: none; color: var(--text-color); font-size: 1em;
            margin-left: 25px; cursor: pointer; padding: 8px 15px; transition: 0.3s; border-radius: 20px;
        }

        .nav-links button:hover { color: var(--hover-color); background: rgba(0, 255, 255, 0.1); }
        .nav-links button.active { color: var(--bg-primary); background: var(--accent-color); box-shadow: 0 0 15px var(--accent-color); }

        .page-frame { display: none; padding: 40px 20px; max-width: 1100px; margin: auto; animation: fadeIn 0.5s ease; }
        .page-frame.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card {
            background: var(--card-bg); border: 1px solid rgba(0, 188, 212, 0.2);
            border-radius: 15px; padding: 30px; margin-bottom: 20px; backdrop-filter: blur(10px);
        }

        .aquatic-btn {
            background: linear-gradient(135deg, #008ba3, #00bcd4);
            color: white; border: none; padding: 12px 30px; border-radius: 50px;
            font-weight: bold; cursor: pointer; transition: 0.4s; text-decoration: none; display: inline-block;
        }

        .aquatic-btn:hover { transform: scale(1.05); box-shadow: 0 0 20px var(--hover-color); }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; color: var(--accent-color); padding: 10px; border-bottom: 1px solid #333; }
        td { padding: 15px 10px; border-bottom: 1px solid #222; }

        #logoutbutton { display: none; }

        /* Modal / Popup */
        #signupModal {
            display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
            background:rgba(0,0,0,0.9); z-index:2000; align-items:center; justify-content:center;
        }
    </style>
</head>
<body>

    <nav>
        <div class="logo">Whales of Margin</div>
        <div class="nav-links">
            <button id="nav-home" class="active" onclick="openPage('home')">Home</button>
            <button id="nav-swap" onclick="openPage('swap')">Swap</button>
            <button id="nav-portfolio" onclick="openPage('portfolio')">Portfolio</button>
            <button id="logoutbutton" onclick="logout()">Logout</button>
        </div>
    </nav>

    <div id="home" class="page-frame active">
        <div class="card">
            <h1 id="accountaddress">...</h1>
            <h1>Ocean-Floor Deep Liquidity</h1>
            <p>Welcome to the 2025 Premium XRPL Interface. Clean tokens, verified RWAs, and zero-custody risk.</p>
            <button id="signinbutton" class="aquatic-btn" onclick="doSignIn()">Connect Xaman Wallet</button> 
        </div>
        
        <div class="card">
            <h3>Top Verified Utility Tokens</h3>
            <table>
                <thead>
                    <tr><th>Asset</th><th>Balance</th><th>Value (XRP)</th><th>Status</th></tr>
                </thead>
                <tbody>
                    <tr><td>Gold-RWA</td><td>10.5 oz</td><td>4,200</td><td style="color: #00ff00;">Verified</td></tr>
                    <tr><td>Utility-Node</td><td>1,000,000</td><td>850</td><td style="color: #00ff00;">Active</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="swap" class="page-frame">
        <div class="card">
            <h2>Aquatic Swap</h2>
            <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 10px;">
                <label>From: XRP</label>
                <input type="number" placeholder="0.00" style="width: 100%; padding: 10px; margin: 10px 0; background: #050b14; color: white; border: 1px solid #333;">
                <label>To: [Select Verified Token]</label>
                <button class="aquatic-btn" style="width: 100%; margin-top: 10px;">Review Swap</button>
            </div>
        </div>
    </div>

    <div id="portfolio" class="page-frame">
        <div class="card">
            <h2>Your Deep Sea Vault</h2>
            <p>Hashed Identity: <span id="userHashDisplay" style="color: var(--accent-color);">[Not Connected]</span></p>
            <table id="portfolioTable">
                <thead>
                    <tr><th>Asset</th><th>Balance</th><th>Value (XRP)</th><th>Status</th></tr>
                </thead>
                <tbody id="portfolioTableBody">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="signupModal">
        <div class="card" style="max-width:400px; text-align:center; border: 2px solid var(--accent-color);">
            <h2 style="color:var(--accent-color);">Member Access Required</h2>
            <p>The Swap and Portfolio vaults are restricted to approved members.</p>
            <button onclick="closeModal()" style="background:none; border:none; color:#555; cursor:pointer; text-decoration:underline;">Return to Home</button>
        </div>
    </div>

    <script src="https://xumm.app/assets/cdn/xumm.min.js"></script>
    <script>
        const xumm = new Xumm('c5faed1c-cd38-4f99-ab56-73432c940bb2');
        let userLoggedIn = false;

 xumm.on("ready", async () => {
    // 1. Function to refresh the UI
    const checkSession = async () => {
        const account = await xumm.user.account;
        if (account) {
            handleSuccess(account);
        }
    };

    // 2. Run check immediately on load
    checkSession();

    // 3. FORCE REFRESH when the user returns to the tab (The Mobile Fix)
    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "visible") {
            checkSession();
        }
    });

    // 4. Handle the URL Payload (The "Direct Return" from Xaman)
    const urlParams = new URLSearchParams(window.location.search);
    const pId = urlParams.get('xummPayloadUUID');
    if (pId) {
        const res = await xumm.payload.get(pId);
        if (res?.response?.account) {
            handleSuccess(res.response.account);
            // Clean the URL so the back button works nicely
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    }
});

        async function doSignIn() {
            xumm.authorize().catch(err => alert("Sign-in Error: " + err.message));
        }

        async function handleSuccess(account) {
    userLoggedIn = true;
    document.getElementById('accountaddress').innerText = account;
    
    // 1. Fetch real data from the ledger
    const tokens = await getLedgerBalances(account);
    const tableBody = document.getElementById("portfolioTableBody");
    
    // 2. Clear the table and inject real rows
    tableBody.innerHTML = ""; 

    if (tokens.length === 0) {
        tableBody.innerHTML = "<tr><td colspan='4'>No tokens found in this vault.</td></tr>";
    }

    tokens.forEach(token => {
        // We convert hex currency codes (like 584C53...) to readable names if needed
        let currencyName = token.currency.length > 3 ? "Custom Token" : token.currency;
        
        tableBody.innerHTML += `
            <tr>
                <td>${currencyName}</td>
                <td>${parseFloat(token.balance).toFixed(2)}</td>
                <td>--</td> 
                <td style="color: #00ff00;">On-Chain</td>
            </tr>
        `;
    });
}
        function openPage(pageId) {
            if ((pageId === 'swap' || pageId === 'portfolio') && !userLoggedIn) {
                document.getElementById('signupModal').style.display = 'flex';
                return;
            }
            document.querySelectorAll('.page-frame').forEach(f => f.classList.remove('active'));
            document.querySelectorAll('.nav-links button').forEach(b => b.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.getElementById('nav-' + pageId).classList.add('active');
        }

        function closeModal() { document.getElementById('signupModal').style.display = 'none'; }
        function logout() { xumm.logout(); location.reload(); }
        async function getLedgerBalances(walletAddress) {
    const response = await fetch("https://xrplcluster.com", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            method: "account_lines",
            params: [{
                account: walletAddress,
                ledger_index: "validated"
            }]
        })
    });

    const data = await response.json();
    return data.result.lines; // This is the list of tokens
}
    </script>
</body>
</html>            
