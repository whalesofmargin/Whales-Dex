<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whales of Margin | 2025 DEX</title>
    <base target="_top">
    <style>
        :root {
            --bg-primary: #050b14;
            --bg-secondary: #0a192f; 
            --accent-color: #00bcd4;
            --hover-color: #00ffff; 
            --text-color: #e6f1ff;
            --card-bg: rgba(16, 33, 62, 0.8);
            --border-glow: 0 0 10px rgba(0, 188, 212, 0.3);
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-color);
            margin: 0;
            overflow-x: hidden;
        }

        nav {
            background-color: var(--bg-secondary);
            padding: 15px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid var(--accent-color);
            box-shadow: var(--border-glow);
        }

        .logo { color: var(--accent-color); font-size: 1.5em; font-weight: bold; letter-spacing: 2px; text-transform: uppercase; }

        .nav-links button {
            background: none; border: none; color: var(--text-color); font-size: 1em;
            margin-left: 25px; cursor: pointer; padding: 8px 15px; transition: 0.3s; border-radius: 20px;
        }

        .nav-links button:hover { color: var(--hover-color); background: rgba(0, 255, 255, 0.1); }
        .nav-links button.active { color: var(--bg-primary); background: var(--accent-color); box-shadow: 0 0 15px var(--accent-color); }

        .page-frame { display: none; padding: 40px 20px; max-width: 1100px; margin: auto; animation: fadeIn 0.5s ease; }
        .page-frame.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card {
            background: var(--card-bg); border: 1px solid rgba(0, 188, 212, 0.2);
            border-radius: 15px; padding: 30px; margin-bottom: 20px; backdrop-filter: blur(10px);
        }

        .aquatic-btn {
            background: linear-gradient(135deg, #008ba3, #00bcd4);
            color: white; border: none; padding: 12px 30px; border-radius: 50px;
            font-weight: bold; cursor: pointer; transition: 0.4s; text-decoration: none; display: inline-block;
        }

        .aquatic-btn:hover { transform: scale(1.05); box-shadow: 0 0 20px var(--hover-color); }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; color: var(--accent-color); padding: 10px; border-bottom: 1px solid #333; }
        td { padding: 15px 10px; border-bottom: 1px solid #222; }

        #logoutbutton { display: none; }

        /* Modal / Popup */
        #signupModal {
            display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
            background:rgba(0,0,0,0.9); z-index:2000; align-items:center; justify-content:center;
        }
            .nft-card {
    background: rgba(0, 0, 0, 0.4);
    border-radius: 12px;
    padding: 10px;
    border: 1px solid #1a2a44;
    transition: 0.3s;
    text-align: center;
}
.nft-card:hover { border-color: var(--accent-color); transform: translateY(-5px); }

.nft-thumb {
    width: 100%;
    aspect-ratio: 1/1; /* Keeps them perfectly square */
    object-fit: cover; /* Crops image to fit without stretching */
    border-radius: 8px;
    margin-bottom: 10px;
}
.nft-name { font-weight: bold; font-size: 0.9em; display: block; }
.nft-meta { font-size: 0.75em; color: #888; }
    </style>
</head>
<body>

    <nav>
        <div class="logo">Whales of Margin</div>
        <div class="nav-links">

            <button class="active" onclick="openPage('home')">Home</button>
            <button onclick="openPage('swap')">Swap</button>
            <button onclick="openPage('portfolio')">Portfolio</button>
            <button onclick="openPage('nftfinder')">NFT Search</button>
            <button id="logoutbutton" onclick="xumm.logout()">Logout</button>
        </div>
    </nav>

    <div id="home" class="page-frame active">
        <div class="card">
            <h1 id="accountaddress">...</h1>
            <h1>Ocean-Floor Deep Liquidity</h1>
            <p>Welcome to the 2025 Premium XRPL Interface. Clean tokens, verified RWAs, and zero-custody risk.</p>
            <button id="signinbutton" class="aquatic-btn" onclick="doSignIn()">Connect Xaman Wallet</button> 
        </div>
        
        <div class="card">
            <h3>Top Verified Utility Tokens</h3>
      
            <table id="portfolioTable">
        <thead>
            <tr><th>Asset</th><th>Issuer</th><th>Status</th></tr>
        </thead>
        <tbody id="homeTokenTable">
            </tbody>
    </table>
        </div>
    </div>

    <div id="swap" class="page-frame">
        <div class="card">
            <h2>Aquatic Swap</h2>
            <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 10px;">
                <label>From: XRP</label>
                <input type="number" placeholder="0.00" style="width: 100%; padding: 10px; margin: 10px 0; background: #050b14; color: white; border: 1px solid #333;">
                <label>To: [Select Verified Token]</label>
                <button class="aquatic-btn" style="width: 100%; margin-top: 10px;">Review Swap</button>
            </div>
        </div>
    </div>

    <div id="portfolio" class="page-frame">
        <div class="card">
            <h2>Your Deep Sea Vault</h2>
            <p>Hashed Identity: <span id="userHashDisplay" style="color: var(--accent-color);">[Not Connected]</span></p>
            <table id="portfolioTable">
                <thead>
                    <tr><th>Asset</th><th>Balance</th><th>Value (XRP)</th><th>Status</th></tr>
                </thead>
                <tbody id="portfolioTableBody">
                    </tbody>
            </table>
        </div>
    </div>
<div id="nftfinder" class="page-frame">
    <div class="card">
        <h2>Vault Artifacts</h2>
        <p>Enter an XRPL address to scan for on-chain collectibles.</p>
        <div style="display:flex; gap:10px; margin-bottom: 20px;">
            <input type="text" id="walletSearchInput" placeholder="Enter r-address (e.g. rP9jPy...)" 
                   style="flex-grow:1; padding:12px; background:#050b14; color:white; border:1px solid var(--accent-color); border-radius: 8px;">
            <button class="aquatic-btn" onclick="searchWalletNFTs()">Search Vault</button>
        </div>
        
        <input type="text" id="nftSearch" placeholder="Filter results by name..." 
               style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #333; background: rgba(0,0,0,0.2); color: white;">
    </div>

    <div id="nftGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px;">
        <p style="text-align: center; color: #555; grid-column: 1 / -1;">Enter a wallet address above to begin the scan.</p>
    </div>
</div>
    <div id="signupModal">
        <div class="card" style="max-width:400px; text-align:center; border: 2px solid var(--accent-color);">
            <h2 style="color:var(--accent-color);">Member Access Required</h2>
            <p>The Swap and Portfolio vaults are restricted to approved members.</p>
            <button onclick="closeModal()" style="background:none; border:none; color:#555; cursor:pointer; text-decoration:underline;">Return to Home</button>
        </div>
    </div>
<script src="https://xumm.app/assets/cdn/xumm.min.js"></script>
<script>
// 1. The main search function
async function searchWalletNFTs() {
    const wallet = document.getElementById('walletSearchInput').value.trim();
    const grid = document.getElementById('nftGrid');
    
    if (!wallet) return;

    grid.innerHTML = "<p>Scanning Vault...</p>";

    try {
        // We use the direct XRPData API that your Google Sheet used
        const response = await fetch(`https://api.xrpldata.com/api/v1/xls20-nfts/owner/${wallet}`, {
            method: 'GET',
            mode: 'cors' // This is the crucial setting for Browsers
        });

        if (!response.ok) throw new Error("API Response was not OK");

        const result = await response.json();
        console.log("Data Received:", result); // Look for this in F12 Console

        const nfts = result?.data?.nfts || [];

        if (nfts.length === 0) {
            grid.innerHTML = "<p>No Artifacts found.</p>";
            return;
        }

        grid.innerHTML = ""; // Clear the "Scanning" text

        nfts.forEach(nft => {
            const cardId = `nft-${nft.NFTokenID}`;
            const decodedUri = hexToText(nft.URI);
            const finalImage = formatIpfsUrl(decodedUri);

            grid.innerHTML += `
                <div class="nft-card" id="${cardId}">
                    <img src="${finalImage}" class="nft-thumb" 
                         onerror="this.src='https://via.placeholder.com/150?text=No+Image'">
                    <span class="nft-name">Serial: ${nft.nft_serial}</span>
                    <button class="aquatic-btn" onclick="window.open('https://bithomp.com/nft/${nft.NFTokenID}')">
                        Bithomp
                    </button>
                </div>
            `;
        });

    } catch (err) {
        console.error("Detailed Error:", err); // This tells us WHY it failed
        grid.innerHTML = `<p style="color:red;">Connection Error: ${err.message}</p>`;
    }
}
async function fetchMetadata(url, cardId, serial) {
    const card = document.getElementById(cardId);
    if (!card) return;

    try {
        // Try to fetch the data as JSON first
        const response = await fetch(url);
        const contentType = response.headers.get("content-type");

        if (contentType && contentType.includes("application/json")) {
            const metadata = await response.json();
            
            // Look for the image inside the JSON (common keys: image, animation_url)
            let imageUri = metadata.image || metadata.animation_url || metadata.video;
            let finalImage = formatIpfsUrl(imageUri);

            updateNftCard(card, finalImage, metadata.name || `Artifact ${serial}`);
        } else {
            // If it's NOT JSON, the URL itself is likely the image (Direct Image NFT)
            updateNftCard(card, url, `Artifact ${serial}`);
        }
    } catch (e) {
        // If fetch fails (CORS error), we use a direct <img> tag fallback
        // Browsers handle <img> tags differently than fetch()â€”they bypass most CORS rules!
        updateNftCard(card, url, `Artifact ${serial}`);
    }
}

function updateNftCard(card, imageUrl, name) {
    card.innerHTML = `
        <img src="${imageUrl}" class="nft-thumb" loading="lazy" 
             onerror="this.src='https://via.placeholder.com/150?text=Scan+Error'">
        <span class="nft-name">${name}</span>
        <button class="aquatic-btn" style="font-size: 0.7em;" 
                onclick="window.open('https://bithomp.com/nft/${card.id.replace('nft-','')}')">Ledger</button>
    `;
}
    function formatIpfsUrl(uri) {
    if (!uri) return "";

    // 1. Clean the URI (removes ipfs:// and handles your # replacement)
    let cidPath = uri.replace(/^ipfs:\/\/?/, "");
    cidPath = cidPath.split('#').join('%23');

    // 2. We use 'pinata' or 'cloudflare' as they are often faster than the default ipfs.io
    // You can swap the order of these to see which is faster for your specific NFTs
    return `https://gateway.pinata.cloud/ipfs/${cidPath}`;
}
    async function mintNFT() {
    // This is the transaction "recipe" for an NFT purchase/mint
    const payload = {
        "txjson": {
            "TransactionType": "NFTokenCreateOffer", 
            "Account": xumm.user.account,
            "Amount": "10000000", // 10 XRP in drops (1 million drops = 1 XRP)
            "NFTokenID": "00080000...", // The ID of the NFT from the cafe
            "Flags": 1
        }
    };
const mintTime = new Date("2025-12-31T12:00:00Z").getTime();

setInterval(() => {
    const now = new Date().getTime();
    const distance = mintTime - now;

    if (distance <= 0) {
        document.getElementById("mintBtn").disabled = false;
        document.getElementById("mintBtn").innerText = "MINT NOW";
    } else {
        document.getElementById("mintBtn").innerText = "Locked: " + Math.floor(distance / 1000) + "s";
    }
}, 1000);
    // Send the request to the user's phone
    const request = await xumm.payload.create(payload);
    
    if (request.next.always) {
        // Open Xaman to sign
        window.open(request.next.always, '_blank');
    }
}
    function hexToName(hex) {
    if (!hex || hex.length <= 3) return hex;
    try {
        let str = '';
        for (let i = 0; i < hex.length; i += 2) {
            let charCode = parseInt(hex.substr(i, 2), 16);
            if (charCode === 0) break; // End of string padding
            str += String.fromCharCode(charCode);
        }
        return str.trim();
    } catch (e) {
        return "Custom Token";
    }
}
    const APPROVED_TOKENS = [
    { 
        name: "XOGE", 
        currency: "586F676500000000000000000000000000000000", 
        issuer: "rJMtvf5B3GbuFMrqybh5wYVXEH4QE8VyU1", // Example Issuer
        icon: "https://uas.xrpscan.com/x/ClassyXoge?ttl=24h&fallback=https://xrpscan.com/static/media/xrpl-symbol-black.cc259dd1.svg&k=4" 
    },
    { 
        name: "Freedom Phoenix Token", 
        currency: "FPT", 
        issuer: "rBXRBN9gSFE4qL6DGWYHgKCLtoMzUVL5cF", // Example Issuer
        icon: "https://s1.xrplmeta.org/icon/8BE01E0146.webp" 
    },
    { 
        name: "NBunnU", 
        currency: "4E42554E4E550000000000000000000000000000", 
        issuer: "rsdDZFHp1GXp1GMacDFne2ekSjjfWmhvKu", // Example Issuer
        icon: "https://s1.xrplmeta.org/icon/A3F84903B7.webp" 
    },
    { 
        name: "Xmeme", 
        currency: "584D454D45000000000000000000000000000000", 
        issuer: "r4UPddYeGeZgDhSGPkooURsQtmGda4oYQW", // Example Issuer
        icon: "https://xrpscan.com/static/media/xrpl-symbol-black.cc259dd1.svg" 
    },
    { 
        name: "Blue Umbrella Token", 
        currency: "BUT", 
        issuer: "riQtZKAtGWGRThMNBGz8RtLGAKHd7Za8x", // Example Issuer
        icon: "https://www.gravatar.com/avatar/7839824a835a6b047cc6a1a7f2ce3b73.png?d=blank&s=400" 
    },
    { 
        name: "Lynx", 
        currency: "244C594E58000000000000000000000000000000", 
        issuer: "rsr8BspVLwDWgrYamEJE3mqZhKozfWLfkv", // Example Issuer
        icon: "https://s1.xrplmeta.org/icon/A064B0A41A.webp" 
    },
    { 
        name: "UgA BuGa", 
        currency: "UGA", 
        issuer: "rBFJGmWj6YaabVCxfsjiCM8pfYXs8xFdeC", // Example Issuer
        icon: "https://s1.xrplmeta.org/icon/3F77861A34.webp" 
    },
    { 
        name: "X Joy", 
        currency: "584A4F5900000000000000000000000000000000", 
        issuer: "rJAvx8FtrLR3RyZyM1LyVQFxxsLdT1PmdS", // Example Issuer
        icon: "https://xrpscan.com/static/media/xrpl-symbol-black.cc259dd1.svg" 
    },
    { 
        name: "xSPECTAR", 
        currency: "7853504543544152000000000000000000000000", 
        issuer: "rh5jzTCdMRCVjQ7LT6zucjezC47KATkuvv", // Example Issuer
        icon: "https://uas.xrpscan.com/x/xspectar?ttl=24h&fallback=https://xrpscan.com/static/media/xrpl-symbol-black.cc259dd1.svg&k=4" 
    },
    { 
        name: "Equilibrium games", 
        currency: "457175696C69627269756D000000000000000000", 
        issuer: "rpakCr61Q92abPXJnVboKENmpKssWyHpwu", // Example Issuer
        icon: "https://uas.xrpscan.com/x/Equilibrium_G?ttl=24h&fallback=https://xrpscan.com/static/media/xrpl-symbol-black.cc259dd1.svg&k=4" 
    },
    { 
        name: "Health Ai", 
        currency: "4841494300000000000000000000000000000000", 
        issuer: "rsEXqMHTKDfGzncfJ25XtB9ZY8jayTv7N3", // Example Issuer
        icon: "https://uas.xrpscan.com/x/healthaicoin?ttl=24h&fallback=https://xrpscan.com/static/media/xrpl-symbol-black.cc259dd1.svg&k=4" 
    }
];
    const xumm = new Xumm('c5faed1c-cd38-4f99-ab56-73432c940bb2');
    let userLoggedIn = false;
function populateHomeDirectory() {
    const tableBody = document.getElementById("homeTokenTable");
    if (!tableBody) return;

    tableBody.innerHTML = ""; // Clear placeholders

    APPROVED_TOKENS.forEach(token => {
        tableBody.innerHTML += `
            <tr>
                <td>
                    <img src="${token.icon}" width="20" style="vertical-align:middle; margin-right:10px;">
                    <strong>${token.name}</strong>
                </td>
                
                <td style="font-family: monospace; font-size: 0.8em;">${token.issuer}</td>
                <td style="color: var(--accent-color);">Verified Artifact</td>
            </tr>
        `;
    });
}
    xumm.on("ready", async () => {
        populateHomeDirectory();
        const checkSession = async () => {
            const account = await xumm.user.account;
            if (account) handleSuccess(account);
        };

        checkSession();

        document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === "visible") checkSession();
        });

        const urlParams = new URLSearchParams(window.location.search);
        const pId = urlParams.get('xummPayloadUUID');
        if (pId) {
            const res = await xumm.payload.get(pId);
            if (res?.response?.account) {
                handleSuccess(res.response.account);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }
    });

    async function doSignIn() {
        xumm.authorize().catch(err => alert("Sign-in Error: " + err.message));
    }

async function handleSuccess(account) {
    userLoggedIn = true;
    
    // 1. Update UI Elements
    document.getElementById('accountaddress').innerText = account;
    document.getElementById('accountaddress').style.color = 'var(--hover-color)';
    document.getElementById('accountaddress').style.textShadow = '0 0 20px var(--accent-color)';
    document.getElementById('signinbutton').style.display = 'none';
    document.getElementById('logoutbutton').style.display = 'inline-block';
    const hashDisp = document.getElementById('userHashDisplay');
    if (hashDisp) hashDisp.innerText = "Connected: " + account.substring(0, 10);

    try {
        // 2. Fetch the actual tokens from the ledger
        const tokens = await getLedgerBalances(account);
        const tableBody = document.getElementById("portfolioTableBody");
        if (!tableBody) return;

        tableBody.innerHTML = ""; // Clear "Loading..."

        // 3. First: Show all random tokens found in the wallet
        if (tokens && tokens.length > 0) {
            tokens.forEach(token => {
               let currencyName = hexToName(token.currency);
                tableBody.innerHTML += `
                    <tr>
                        <td>${currencyName}</td>
                        <td>${parseFloat(token.balance).toFixed(2)}</td>
                        <td>--</td> 
                        <td style="color: #00ff00;">On-Chain</td>
                    </tr>
                `;
            });
        } else {
            tableBody.innerHTML = "<tr><td colspan='4'>No organic tokens found.</td></tr>";
        }

        // 4. Second: Append the "Approved" artifacts (even if balance is 0)
        populateTokenList(tokens);

    } catch (e) {
        console.error("Ledger error:", e);
        document.getElementById("portfolioTableBody").innerHTML = "<tr><td colspan='4'>Error loading vault data.</td></tr>";
    }
}

    xumm.on("logout", () => {
        userLoggedIn = false;
        location.reload();
    });

    function openPage(pageId) {
        if ((pageId === 'swap' || pageId === 'portfolio') && !userLoggedIn) {
            document.getElementById('signupModal').style.display = 'flex';
            return;
        }
        
        // Hide all pages, show the selected one
        document.querySelectorAll('.page-frame').forEach(f => f.classList.remove('active'));
        const targetPage = document.getElementById(pageId);
        if (targetPage) targetPage.classList.add('active');

        // Update nav button highlights
        document.querySelectorAll('.nav-links button').forEach(b => b.classList.remove('active'));
        // We find the button by its onclick text since IDs weren't added to HTML
        const buttons = document.querySelectorAll('.nav-links button');
        buttons.forEach(btn => {
            if (btn.getAttribute('onclick')?.includes(pageId)) btn.classList.add('active');
        });
    }

    function closeModal() { document.getElementById('signupModal').style.display = 'none'; }

    async function getLedgerBalances(walletAddress) {
        try {
            const response = await fetch("https://xrplcluster.com", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    method: "account_lines",
                    params: [{ account: walletAddress, ledger_index: "validated" }]
                })
            });
            const data = await response.json();
            return data.result.lines || [];
        } catch (e) {
            return [];
        }
    }
    function populateTokenList(userBalances = []) {
    const container = document.getElementById('portfolioTableBody');
    // container.innerHTML = "";  <-- REMOVE OR COMMENT THIS OUT
    
    APPROVED_TOKENS.forEach(approved => {
        // Find if the user owns the approved token
        const match = userBalances.find(b => 
            b.account === approved.issuer && // XRPL uses 'account' for the issuer address
            b.currency === approved.currency
        );

        const balance = match ? parseFloat(match.balance).toFixed(2) : "0.00";
        const status = match ? "Verified" : "Add Trustline";

        container.innerHTML += `
            <tr style="background: rgba(0, 255, 255, 0.05);"> 
                <td><img src="${approved.icon}" width="20" style="vertical-align:middle;"> ${approved.name}</td>
                <td>${balance}</td>
                <td>--</td>
                <td>${status}</td>
            </tr>
        `;
    });
}
</script>
</body>
</html> 
